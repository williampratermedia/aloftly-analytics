---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - drizzle.config.ts
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/app/api/health/route.ts
  - src/app/global-error.tsx
  - src/instrumentation.ts
  - src/instrumentation-client.ts
  - sentry.server.config.ts
  - sentry.edge.config.ts
  - src/lib/utils.ts
  - src/components/ui/
  - .github/workflows/ci.yml
  - .env.example
  - .env.local
autonomous: true
requirements:
  - FOUN-13
  - FOUN-14
  - PROD-07

user_setup:
  - service: vercel
    why: "Deployment target for the application"
    env_vars:
      - name: VERCEL_TOKEN
        source: "Vercel Dashboard -> Settings -> Tokens"
    dashboard_config:
      - task: "Import the aloftly-analytics GitHub repo as a Vercel project"
        location: "Vercel Dashboard -> Add New -> Project"
  - service: sentry
    why: "Error monitoring from first deployed commit"
    env_vars:
      - name: NEXT_PUBLIC_SENTRY_DSN
        source: "Sentry Dashboard -> Project Settings -> Client Keys (DSN)"
      - name: SENTRY_ORG
        source: "Sentry Dashboard -> Organization Settings -> Organization Slug"
      - name: SENTRY_PROJECT
        source: "Sentry Dashboard -> Project Settings -> Project Slug"
      - name: SENTRY_AUTH_TOKEN
        source: "Sentry Dashboard -> Settings -> Auth Tokens -> Create New Token (org:read + project:releases)"
  - service: supabase
    why: "Database and auth provider — env vars needed for Drizzle config and client wrappers"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role secret key"
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection String (pooled, Transaction mode)"
      - name: DATABASE_URL_DIRECT
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection String (direct, non-pooled)"

must_haves:
  truths:
    - "Next.js 15 dev server starts without errors on localhost:3000"
    - "Vercel deployment returns 200 on /api/health"
    - "Sentry instrumentation files exist for server, edge, and client"
    - "Vercel Analytics and SpeedInsights are injected in the root layout"
    - "CI workflow runs lint and build on push to main and on PRs"
    - "shadcn/ui is initialized with Tailwind v4 and violet accent color"
  artifacts:
    - path: "src/app/api/health/route.ts"
      provides: "Health check endpoint"
      exports: ["GET"]
    - path: "src/instrumentation.ts"
      provides: "Sentry server/edge registration"
      exports: ["register", "onRequestError"]
    - path: "src/app/global-error.tsx"
      provides: "Sentry React error boundary"
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline definition"
    - path: "drizzle.config.ts"
      provides: "Drizzle ORM configuration"
  key_links:
    - from: "src/app/layout.tsx"
      to: "@vercel/analytics, @vercel/speed-insights"
      via: "Analytics and SpeedInsights component imports"
      pattern: "import.*@vercel/analytics"
    - from: "src/instrumentation.ts"
      to: "sentry.server.config.ts, sentry.edge.config.ts"
      via: "Dynamic import based on NEXT_RUNTIME"
      pattern: "import.*sentry\\.(server|edge)\\.config"
    - from: "next.config.ts"
      to: "@sentry/nextjs"
      via: "withSentryConfig wrapper"
      pattern: "withSentryConfig"
---

<objective>
Bootstrap the Next.js 15 application with TypeScript, Tailwind CSS v4, shadcn/ui, and Drizzle ORM. Deploy to Vercel with a CI/CD pipeline. Instrument Sentry error tracking and Vercel Analytics from the first commit.

Purpose: Every future phase builds on this scaffold. Observability is active before any data pipeline work begins — no flying blind.
Output: A deployed, observable Next.js application with a passing CI pipeline and health check endpoint.
</objective>

<execution_context>
@C:/Users/billy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/billy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project with Tailwind v4, shadcn/ui, and Drizzle ORM</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    drizzle.config.ts
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    src/app/api/health/route.ts
    src/lib/utils.ts
    src/db/index.ts
    .env.example
    .env.local
  </files>
  <action>
    1. Run `npx create-next-app@latest . --typescript --tailwind --app --src-dir --import-alias "@/*"` in the project root (or scaffold manually if files already exist).

    2. Install all dependencies:
       ```bash
       npm install @supabase/supabase-js @supabase/ssr drizzle-orm postgres dotenv sonner zod next-themes
       npm install -D drizzle-kit tsx
       ```

    3. Initialize shadcn/ui: `npx shadcn@latest init`
       - Style: Default
       - Base color: Slate (for the neutral palette)
       - CSS variables: Yes
       - After init, update `src/app/globals.css` to set the violet/purple accent color (#7c3aed / violet-600) as the primary color in the CSS variables. Ensure Tailwind v4 CSS-first config is used — NO tailwind.config.js file.

    4. Create `src/app/api/health/route.ts` — simple GET handler returning `{ status: 'ok', timestamp: new Date().toISOString() }` with 200 status.

    5. Create `drizzle.config.ts` at project root:
       - `out: './src/db/migrations'`
       - `schema: './src/db/schema/index.ts'`
       - `dialect: 'postgresql'`
       - `dbCredentials.url: process.env.DATABASE_URL_DIRECT!`
       - Import `dotenv/config` at top.

    6. Create `src/db/index.ts` — Drizzle client using `postgres` driver with pooled DATABASE_URL. Set `{ prepare: false }` to avoid PgBouncer prepared statement errors. Mark as `'server-only'` import guard.

    7. Create `.env.example` with all required env vars (no values, just keys with comments):
       - NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
       - DATABASE_URL (pooled), DATABASE_URL_DIRECT (direct for migrations)
       - NEXT_PUBLIC_SENTRY_DSN, SENTRY_ORG, SENTRY_PROJECT, SENTRY_AUTH_TOKEN
       - NODE_ENV

    8. Create `.env.local` with placeholder values (gitignored).

    9. Update `src/app/page.tsx` to be a simple landing page with "Aloftly Analytics" heading — placeholder only.

    10. Ensure `.gitignore` includes `.env.local`, `node_modules`, `.next`, `.vercel`.

    IMPORTANT: Do NOT create a `tailwind.config.js` or `tailwind.config.ts` — Tailwind v4 uses CSS-first config via @theme in globals.css.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - `curl http://localhost:3000/api/health` returns `{ "status": "ok", "timestamp": "..." }`
    - `npm run build` completes without errors
    - `drizzle.config.ts` exists and references correct schema path
    - No `tailwind.config.js` or `tailwind.config.ts` file exists
  </verify>
  <done>
    Next.js 15 dev server runs, health check returns 200, build passes, Drizzle is configured, shadcn/ui is initialized with violet accent color, and the project structure matches the architecture from RESEARCH.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Instrument Sentry + Vercel Analytics and create CI/CD pipeline</name>
  <files>
    next.config.ts
    src/instrumentation.ts
    src/instrumentation-client.ts
    sentry.server.config.ts
    sentry.edge.config.ts
    src/app/global-error.tsx
    src/app/layout.tsx
    .github/workflows/ci.yml
  </files>
  <action>
    1. Install Sentry and Vercel Analytics:
       ```bash
       npm install @sentry/nextjs @vercel/analytics @vercel/speed-insights
       ```

    2. Create `sentry.server.config.ts` at project root:
       ```typescript
       import * as Sentry from '@sentry/nextjs'
       Sentry.init({
         dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
         tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
         debug: false,
       })
       ```

    3. Create `sentry.edge.config.ts` with identical config to server config.

    4. Create `src/instrumentation.ts`:
       ```typescript
       export async function register() {
         if (process.env.NEXT_RUNTIME === 'nodejs') {
           await import('../sentry.server.config')
         }
         if (process.env.NEXT_RUNTIME === 'edge') {
           await import('../sentry.edge.config')
         }
       }
       export const onRequestError = (await import('@sentry/nextjs')).captureRequestError
       ```
       NOTE: The `onRequestError` export requires @sentry/nextjs v8.28.0+. Verify the installed version meets this requirement.

    5. Create `src/instrumentation-client.ts` for client-side Sentry init.

    6. Create `src/app/global-error.tsx` — React error boundary that captures errors to Sentry:
       ```typescript
       'use client'
       import * as Sentry from '@sentry/nextjs'
       import { useEffect } from 'react'
       export default function GlobalError({ error, reset }) {
         useEffect(() => { Sentry.captureException(error) }, [error])
         return (
           <html><body>
             <h2>Something went wrong</h2>
             <button onClick={() => reset()}>Try again</button>
           </body></html>
         )
       }
       ```

    7. Update `src/app/layout.tsx`:
       - Add `<Analytics />` from `@vercel/analytics/react`
       - Add `<SpeedInsights />` from `@vercel/speed-insights/next`
       - Both as last children inside `<body>`.

    8. Update `next.config.ts` to wrap with `withSentryConfig`:
       ```typescript
       import { withSentryConfig } from '@sentry/nextjs'
       const nextConfig = { /* existing config */ }
       export default withSentryConfig(nextConfig, {
         org: process.env.SENTRY_ORG,
         project: process.env.SENTRY_PROJECT,
         silent: !process.env.CI,
       })
       ```

    9. Create `.github/workflows/ci.yml`:
       - Trigger: push to main, pull_request to main
       - Steps: checkout, setup Node 20, npm ci, npm run lint, npm run build
       - Do NOT include deployment — Vercel handles that via its GitHub integration.
       - Do NOT include env secrets in CI yet — build should pass without Sentry DSN (Sentry SDK gracefully degrades when DSN is missing).

    10. Verify build still passes after all Sentry/Analytics additions.
  </action>
  <verify>
    - `npm run build` completes without errors
    - `src/instrumentation.ts` exports `register` and `onRequestError`
    - `src/app/global-error.tsx` exists and imports Sentry
    - `src/app/layout.tsx` contains `<Analytics />` and `<SpeedInsights />`
    - `next.config.ts` uses `withSentryConfig`
    - `.github/workflows/ci.yml` exists with lint and build steps
    - `grep -r "tailwind.config" . --include="*.ts" --include="*.js"` returns only drizzle/node_modules references (no Tailwind config file)
  </verify>
  <done>
    Sentry captures server, edge, and client errors. Vercel Analytics and SpeedInsights are injected in the root layout. CI pipeline runs lint and build on every push to main and PR. The build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts the dev server on localhost:3000
2. `curl http://localhost:3000/api/health` returns 200 with JSON body
3. `npm run build` passes without errors
4. Sentry instrumentation files exist: `instrumentation.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`, `global-error.tsx`
5. Root layout includes `<Analytics />` and `<SpeedInsights />`
6. `.github/workflows/ci.yml` defines lint + build steps
7. No `tailwind.config.js` or `tailwind.config.ts` exists
8. shadcn/ui is initialized with violet/purple primary color
</verification>

<success_criteria>
- Next.js 15 app scaffolded with TypeScript, Tailwind v4, shadcn/ui, Drizzle ORM
- Health check endpoint returns 200
- Sentry instrumented for server, edge, and client
- Vercel Analytics and SpeedInsights in root layout
- CI pipeline defined and passing
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
